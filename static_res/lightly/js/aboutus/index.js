layui.use(["jquery","element","code","util","layim"],function(){function createLayim(ws,$,layim,layer,user,userStatus,showInputState){ws.onopen=function(){userInfo={infoType:1,user:""+user},ws.send(JSON.stringify(userInfo))},layim.config({title:"若轻一下",initSkin:"2.jpg",notice:!0,voice:"audio_1.mp3",init:{url:"/plugin/Chat/tools/GetUserInfo.php",type:"get",data:{user:""+user}},members:{url:"/plugin/Chat/tools/GetGroupInfo.php",data:{}},tool:[{alias:"code",title:"代码",icon:"&#xe64e;"}],msgbox:"/res/chat/tools/msgbox.html?v=2",find:"/res/chat/tools/find.html?v=1"}),layim.on("tool(code)",function(e,a,t){layer.prompt({title:"插入代码",formType:2,shade:0},function(t,s){layer.close(s),e("[pre class=layui-code]"+t+"[/pre]"),a()})}),layim.on("ready",function(options){userStatus=options.mine.status,$.ajax({type:"GET",url:"/plugin/Chat/tools/NewFriendsInfo.php",data:"type=0&user="+user,dataType:"json",success:function(res){var result=eval(res);if(1==Number(result.status)&&0!=Number(result.data)){var newMessageTips=$(".layim-tool-msgbox").find("span");newJoin=Number(result.data),newMessageTips.html(newJoin),newMessageTips.addClass("layui-anim-fadein layui-anim-loop"),newMessageTips.css("display","block")}}}),$(".layim-tool-msgbox").click(function(){$(".layim-tool-msgbox").find("span").css("display","none")})}),layim.on("online",function(e){userStatus!=e&&(userStatus=e,userStatusInfo={infoType:3,userStatus:""+e,user:""+user},ws.send(JSON.stringify(userStatusInfo)))}),layim.on("sign",function(e){$.ajax({type:"GET",url:"/plugin/Chat/tools/ChangeUserInfo.php",data:"user="+user+"&type=1&sign="+encodeURIComponent(e)})}),layim.on("chatChange",function(e){var a=e.data.type,t=e.data.id;"friend"===a&&(layim.setChatStatus('<span id="'+t+'InputStatus" style="color:#FF5722;display:none;">对方正在输入。。</span>'),$(".layim-chat-textarea textarea").bind("input propertychange",function(){$(this).val()?inputStatus=1:inputStatus=0,userInputInfo={infoType:4,inputStatus:inputStatus,to:""+t,from:""+user},ws.send(JSON.stringify(userInputInfo))}))}),layim.on("sendMessage",function(e){var a=e.mine,t=e.to;if("friend"==t.type||"group"==t.type){var s={infoType:2,to:""+t.id,from:""+a.id,message:""+a.content,username:""+a.username,avatar:""+a.avatar,type:""+t.type};ws.send(JSON.stringify(s))}}),ws.onmessage=function(res){var res=eval("("+res.data+")");switch(res.state){case 0:break;case 1:layim.on("ready",function(e){for(var a=0;a<res.data.length;a++)layim.getMessage(res.data[a])});break;case 2:layim.getMessage(res.data);break;case 3:"online"==res.data.type?type="online":type="offline",layim.setFriendStatus(res.data.id,type);break;case 4:var inputStatus=res.data.inputStatus,from=res.data.from;"1"==inputStatus?($("#"+from+"InputStatus").css("display","block"),showInputState&&(showInputState=!1,setTimeout(function(){$("#"+from+"InputStatus").css("display","none"),showInputState=!0},5e3))):$("#"+from+"InputStatus").css("display","none");break;case 5:case 6:case 7:newJoin++;var newMessageTips=$(".layim-tool-msgbox").find("span");newMessageTips.html(newJoin),newMessageTips.addClass("layui-anim-fadein layui-anim-loop"),newMessageTips.css("display","block");break;case 8:case 9:layim.addList(res.data);break;case 10:$(".layim-friend"+res.data.userTable).remove()}}}var util=layui.util,$=layui.$,user=layui.data("lightly").user;null==user&&(layer.msg("未登陆"),$(function(){setTimeout(function(){$(location).attr("href","/login.html")},300)}));var layim=layui.layim,initLayim=!0,userStatus="",showInputState=!0,isPC=!0,ajaxIndex=0;newJoin=0,"none"==$(".device-type").css("display")&&(isPC=!1,$(".container-box").css("display","block"),$(".layer-footer").css("display","block")),$(".head-image").attr("src",layui.data("lightly").userInfo.headImage),$(".nickname").html(layui.data("lightly").userInfo.nickname),$(window).width()>=992?$(".main-box").addClass("layui-container"):$(".main-box").removeClass("layui-container"),$(window).resize(function(){$(window).width()>=992?$(".main-box").addClass("layui-container"):$(".main-box").removeClass("layui-container")}),$("#exit").click(function(){layer.open({type:1,title:"提示",offset:"auto",content:'<div style="padding: 20px 100px;">期待与你下次相遇!</div>',btn:"退出账户",btnAlign:"c",shade:0,yes:function(){layer.closeAll(),layui.data("lightly",null),$(location).attr("href","/login.html")}})}),layui.code({elem:"#format",title:"格式样式",about:!1}),util.event("lay-active",{back:function(){$(location).attr("href","../../main.html")}}),isPC&&(initLayim=!1,ws=new WebSocket("ws://lightly.52ch.top:8686"),createLayim(ws,$,layim,layer,user,userStatus,showInputState)),$(window).resize(function(){isPC="none"!=$(".device-type").css("display"),isPC&&initLayim?(initLayim=!1,ws=new WebSocket("ws://lightly.52ch.top:8686"),createLayim(ws,$,layim,layer,user,userStatus,showInputState)):isPC||initLayim||(initLayim=!0,ws.close(),$(".layui-layer").remove())})});