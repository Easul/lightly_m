layui.use(["jquery","element","form","code","layim"],function(){function createLayim(ws,$,layim,layer,user,userStatus,showInputState){ws.onopen=function(){userInfo={infoType:1,user:""+user},ws.send(JSON.stringify(userInfo))},layim.config({title:"若轻一下",initSkin:"2.jpg",notice:!0,voice:"audio_1.mp3",init:{url:"/plugin/Chat/tools/GetUserInfo.php",type:"get",data:{user:""+user}},members:{url:"/plugin/Chat/tools/GetGroupInfo.php",data:{}},tool:[{alias:"code",title:"代码",icon:"&#xe64e;"}],msgbox:"/res/chat/tools/msgbox.html?v=2",find:"/res/chat/tools/find.html?v=1"}),layim.on("tool(code)",function(e,t,a){layer.prompt({title:"插入代码",formType:2,shade:0},function(a,n){layer.close(n),e("[pre class=layui-code]"+a+"[/pre]"),t()})}),layim.on("ready",function(options){userStatus=options.mine.status,$.ajax({type:"GET",url:"/plugin/Chat/tools/NewFriendsInfo.php",data:"type=0&user="+user,dataType:"json",success:function(res){var result=eval(res);if(1==Number(result.status)&&0!=Number(result.data)){var newMessageTips=$(".layim-tool-msgbox").find("span");newJoin=Number(result.data),newMessageTips.html(newJoin),newMessageTips.addClass("layui-anim-fadein layui-anim-loop"),newMessageTips.css("display","block")}}}),$(".layim-tool-msgbox").click(function(){$(".layim-tool-msgbox").find("span").css("display","none")})}),layim.on("online",function(e){userStatus!=e&&(userStatus=e,userStatusInfo={infoType:3,userStatus:""+e,user:""+user},ws.send(JSON.stringify(userStatusInfo)))}),layim.on("sign",function(e){$.ajax({type:"GET",url:"/plugin/Chat/tools/ChangeUserInfo.php",data:"user="+user+"&type=1&sign="+encodeURIComponent(e)})}),layim.on("chatChange",function(e){var t=e.data.type,a=e.data.id;"friend"===t&&(layim.setChatStatus('<span id="'+a+'InputStatus" style="color:#FF5722;display:none;">对方正在输入。。</span>'),$(".layim-chat-textarea textarea").bind("input propertychange",function(){$(this).val()?inputStatus=1:inputStatus=0,userInputInfo={infoType:4,inputStatus:inputStatus,to:""+a,from:""+user},ws.send(JSON.stringify(userInputInfo))}))}),layim.on("sendMessage",function(e){var t=e.mine,a=e.to;if("friend"==a.type||"group"==a.type){var n={infoType:2,to:""+a.id,from:""+t.id,message:""+t.content,username:""+t.username,avatar:""+t.avatar,type:""+a.type};ws.send(JSON.stringify(n))}}),ws.onmessage=function(res){var res=eval("("+res.data+")");switch(res.state){case 0:break;case 1:layim.on("ready",function(e){for(var t=0;t<res.data.length;t++)layim.getMessage(res.data[t])});break;case 2:layim.getMessage(res.data);break;case 3:"online"==res.data.type?type="online":type="offline",layim.setFriendStatus(res.data.id,type);break;case 4:var inputStatus=res.data.inputStatus,from=res.data.from;"1"==inputStatus?($("#"+from+"InputStatus").css("display","block"),showInputState&&(showInputState=!1,setTimeout(function(){$("#"+from+"InputStatus").css("display","none"),showInputState=!0},5e3))):$("#"+from+"InputStatus").css("display","none");break;case 5:case 6:case 7:newJoin++;var newMessageTips=$(".layim-tool-msgbox").find("span");newMessageTips.html(newJoin),newMessageTips.addClass("layui-anim-fadein layui-anim-loop"),newMessageTips.css("display","block");break;case 8:case 9:layim.addList(res.data);break;case 10:$(".layim-friend"+res.data.userTable).remove()}}}function initQuestionType(){form.on("select(subject)",function(e){for(var t=layui.data("lightly").questionType[Number(e.value)],a=t.split(""),n=["选择","判断","填空","编程"],s='<option value="" selected=""></option>',i=0;i<4;i++)Number(a[i])&&(s+='<option value="'+i+'">'+n[i]+"</option>");$("[lay-filter='questionType']").html(""),$("[lay-filter='questionType']").append(s),form.render(),selectQuestionType()})}function selectQuestionType(){form.on("select(questionType)",function(e){var t=Number(e.value);t?($(".select-option").removeAttr("checked"),$(".judge-option").prop("checked","true")):($(".judge-option").removeAttr("checked"),$(".select-option").prop("checked","true")),form.render("radio");for(var a=["select","judge","fill","program"],n=0;n<4;n++)$("."+a[n]+"-box").find("input").attr("lay-verify",""),$("."+a[n]+"-box").css("display","none");$("."+a[t]+"-box").find("input").attr("lay-verify","required"),$("."+a[t]+"-box").css("display","block"),$.ajax({async:!1,success:function(){questionTypeNumber=a[t]}})})}var $=layui.$,form=layui.form,user=layui.data("lightly").user;questionTypeNumber=0,null==user&&(layer.msg("未登陆"),$(function(){setTimeout(function(){$(location).attr("href","/login.html")},300)}));var layim=layui.layim,initLayim=!0,userStatus="",showInputState=!0,isPC=!0,ajaxIndex=0;newJoin=0;var allPageLoad=layer.open({type:3,shade:[1,"#ffffff"]});$.ajax({type:"GET",url:"/plugin/LittleFunction/Search.php",data:"type=6&user="+user,dataType:"json",success:function(res){var result=eval(res);1==Number(result.status)&&Number(1!=result.data)?layer.open({type:1,title:"提示",offset:"auto",content:'<div style="padding: 20px 100px;">仅限管理员上传!<br>如需上传权限请后台反馈</div>',btn:"确认",btnAlign:"c",shade:[1,"#ffffff"],yes:function(){$(location).attr("href","/main.html")},cancel:function(){$(location).attr("href","/main.html")}}):1!=Number(result.status)&&layer.open({type:1,title:"提示",offset:"auto",content:'<div style="padding: 20px 100px;">参数错误</div>',btn:"确认",btnAlign:"c",shade:[1,"#ffffff"],yes:function(){$(location).attr("href","/main.html")},cancel:function(){$(location).attr("href","/main.html")}})}}),"none"==$(".device-type").css("display")&&(isPC=!1,$(".container-box").css("display","block"),$(".layer-footer").css("display","block")),$(".head-image").attr("src",layui.data("lightly").userInfo.headImage),$(".nickname").html(layui.data("lightly").userInfo.nickname),$("#exit").click(function(){layer.open({type:1,title:"提示",offset:"auto",content:'<div style="padding: 20px 100px;">期待与你下次相遇!</div>',btn:"退出账户",btnAlign:"c",shade:0,yes:function(){layer.closeAll(),layui.data("lightly",null),$(location).attr("href","/login.html")}})}),$.ajax({type:"GET",url:"/plugin/LittleFunction/Search.php",data:"type=5",dataType:"json",success:function(data){var result=eval(data);if(1==Number(result.status)){for(var dom="",questionType=[],i=0;i<result.data.length;i++)dom+='<option value="'+result.data[i][1]+'">'+result.data[i][0]+"</option>",questionType.push(result.data[i][2]);$('select[lay-filter="subject"]').append(dom),layui.data("lightly",{key:"questionType",value:questionType}),form.render(),initQuestionType()}0==ajaxIndex?(layer.close(allPageLoad),$(".layui-container").css("display","block"),$(".phone-nav").css("display","block")):ajaxIndex++}}),layui.code({height:"200px",about:!1}),$(".single-question").click(function(){$(".import-question-button").css("display","none"),$(".single-question-form").css("display","block")}),$(".multi-question").click(function(){$(".import-question-button").css("display","none"),$(".multi-question-form").css("display","block")}),form.on("submit(submitFormSingle)",function(data){var uploadLoad=layer.open({type:3,shade:[.5,"#000000"]}),languageType=data.field.languageType,questionType=data.field.questionType,singleQuestion=encodeURIComponent(data.field.singleQuestion),answerStr="";switch(questionTypeNumber){case"select":var singleAnswerA=encodeURIComponent(data.field.singleAnswerA),singleAnswerB=encodeURIComponent(data.field.singleAnswerB),singleAnswerC=encodeURIComponent(data.field.singleAnswerC),singleAnswerD=encodeURIComponent(data.field.singleAnswerD),answer=encodeURIComponent(data.field.selectAnswer);answerStr="&singleAnswerA="+singleAnswerA+"&singleAnswerB="+singleAnswerB+"&singleAnswerC="+singleAnswerC+"&singleAnswerD="+singleAnswerD+"&answer="+answer;break;case"judge":var answer=encodeURIComponent(data.field.judgeAnswer);answerStr="&answer="+answer;break;case"fill":var answer=encodeURIComponent(data.field.fillAnswer);answerStr="&answer="+answer;break;case"program":var answer=encodeURIComponent(data.field.programAnswer);answerStr="&answer="+answer}return $.ajax({type:"POST",url:"/plugin/QuestionOperation/UploadQuestion.php",data:"uploadType=0&languageType="+languageType+"&questionType="+questionType+"&singleQuestion="+singleQuestion+answerStr+"&userTable="+user,dataType:"json",success:function(data){layer.close(uploadLoad);var result=eval(data);1==Number(result.status)?layer.msg("添加成功！"):layer.msg("添加失败!")}}),!1}),form.on("submit(submitFormMulti)",function(data){var uploadLoad=layer.open({type:3,shade:[.5,"#000000"]}),languageTypeMulti=data.field.languageTypeMulti,questionTypeMulti=data.field.questionTypeMulti,multiQuestion=encodeURIComponent(data.field.multiQuestion);return $.ajax({type:"POST",url:"/plugin/QuestionOperation/UploadQuestion.php",data:"uploadType=1&languageType="+languageTypeMulti+"&questionType="+questionTypeMulti+"&multiQuestion="+multiQuestion+"&userTable="+user,dataType:"json",success:function(data){layer.close(uploadLoad);var result=eval(data);1==Number(result.status)?layer.msg("添加成功！"):layer.msg("添加失败!")}}),!1}),isPC&&(initLayim=!1,ws=new WebSocket("ws://lightly.52ch.top:8686"),createLayim(ws,$,layim,layer,user,userStatus,showInputState)),$(window).resize(function(){isPC="none"!=$(".device-type").css("display"),isPC&&initLayim?(initLayim=!1,ws=new WebSocket("ws://lightly.52ch.top:8686"),createLayim(ws,$,layim,layer,user,userStatus,showInputState)):isPC||initLayim||(initLayim=!0,ws.close(),$(".layui-layer").remove())})});