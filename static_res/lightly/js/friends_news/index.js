layui.use(["element","layer","jquery","layim"],function(){function createLayim(ws,$,layim,layer,user,userStatus,showInputState){ws.onopen=function(){userInfo={infoType:1,user:""+user},ws.send(JSON.stringify(userInfo))},layim.config({title:"若轻一下",initSkin:"2.jpg",notice:!0,voice:"audio_1.mp3",init:{url:"/plugin/Chat/tools/GetUserInfo.php",type:"get",data:{user:""+user}},members:{url:"/plugin/Chat/tools/GetGroupInfo.php",data:{}},tool:[{alias:"code",title:"代码",icon:"&#xe64e;"}],msgbox:"/res/chat/tools/msgbox.html?v=2",find:"/res/chat/tools/find.html?v=1"}),layim.on("tool(code)",function(t,e,a){layer.prompt({title:"插入代码",formType:2,shade:0},function(a,i){layer.close(i),t("[pre class=layui-code]"+a+"[/pre]"),e()})}),layim.on("ready",function(options){userStatus=options.mine.status,$.ajax({type:"GET",url:"/plugin/Chat/tools/NewFriendsInfo.php",data:"type=0&user="+user,dataType:"json",success:function(res){var result=eval(res);if(1==Number(result.status)&&0!=Number(result.data)){var newMessageTips=$(".layim-tool-msgbox").find("span");newJoin=Number(result.data),newMessageTips.html(newJoin),newMessageTips.addClass("layui-anim-fadein layui-anim-loop"),newMessageTips.css("display","block")}}}),$(".layim-tool-msgbox").click(function(){$(".layim-tool-msgbox").find("span").css("display","none")})}),layim.on("online",function(t){userStatus!=t&&(userStatus=t,userStatusInfo={infoType:3,userStatus:""+t,user:""+user},ws.send(JSON.stringify(userStatusInfo)))}),layim.on("sign",function(t){$.ajax({type:"GET",url:"/plugin/Chat/tools/ChangeUserInfo.php",data:"user="+user+"&type=1&sign="+encodeURIComponent(t)})}),layim.on("chatChange",function(t){var e=t.data.type,a=t.data.id;"friend"===e&&(layim.setChatStatus('<span id="'+a+'InputStatus" style="color:#FF5722;display:none;">对方正在输入。。</span>'),$(".layim-chat-textarea textarea").bind("input propertychange",function(){$(this).val()?inputStatus=1:inputStatus=0,userInputInfo={infoType:4,inputStatus:inputStatus,to:""+a,from:""+user},ws.send(JSON.stringify(userInputInfo))}))}),layim.on("sendMessage",function(t){var e=t.mine,a=t.to;if("friend"==a.type||"group"==a.type){var i={infoType:2,to:""+a.id,from:""+e.id,message:""+e.content,username:""+e.username,avatar:""+e.avatar,type:""+a.type};ws.send(JSON.stringify(i))}}),ws.onmessage=function(res){var res=eval("("+res.data+")");switch(res.state){case 0:break;case 1:layim.on("ready",function(t){for(var e=0;e<res.data.length;e++)layim.getMessage(res.data[e])});break;case 2:layim.getMessage(res.data);break;case 3:"online"==res.data.type?type="online":type="offline",layim.setFriendStatus(res.data.id,type);break;case 4:var inputStatus=res.data.inputStatus,from=res.data.from;"1"==inputStatus?($("#"+from+"InputStatus").css("display","block"),showInputState&&(showInputState=!1,setTimeout(function(){$("#"+from+"InputStatus").css("display","none"),showInputState=!0},5e3))):$("#"+from+"InputStatus").css("display","none");break;case 5:case 6:case 7:newJoin++;var newMessageTips=$(".layim-tool-msgbox").find("span");newMessageTips.html(newJoin),newMessageTips.addClass("layui-anim-fadein layui-anim-loop"),newMessageTips.css("display","block");break;case 8:case 9:layim.addList(res.data);break;case 10:$(".layim-friend"+res.data.userTable).remove()}}}function unix2common(t){var e=new Date(1e3*t);return e.toLocaleString()}function clickThumbOrTread(){function doTotTransport(t,e,a,i){$.ajax({type:"GET",url:"/plugin/LittleFunction/Change.php",data:"type=2&user="+t+"&userId="+e+"&totType="+a+"&newsId="+i})}$(".thumb-btn").click(function(){if(0==Number($(this).attr("totState"))){$(this).css("color","#FF5722"),$(this).attr("totState","1"),$(this).nextAll("i").attr("totState","1");var t=Number($(this).next().html());$(this).next().html(++t),layer.msg("点赞成功 !");var e=$(this).parents("li.owner-li").attr("userId"),a=$(this).parent().parent().parent("li").attr("newsId");a.indexOf(":")>0&&(a=a.split(":")[1]),doTotTransport(user,e,1,a)}}),$(".tread-btn").click(function(){if(0==Number($(this).attr("totState"))){$(this).css("color","#FF5722"),$(this).attr("totState","2"),$(this).prevAll("i").attr("totState","2");var t=Number($(this).next().html());$(this).next().html(++t),layer.msg("竟然踩了 !");var e=$(this).parents("li.owner-li").attr("userId"),a=$(this).parent().parent().parent("li").attr("newsId");a.indexOf(":")>0&&(a=a.split(":")[1]),doTotTransport(user,e,2,a)}}),$(".dialogue-btn").click(function(){var ownerDom=$(this).parent().parent().parent("li"),userId=$(this).parents("li.owner-li").attr("userId"),newsId=ownerDom.attr("newsId"),ownerNickname=ownerDom.children("div.layui-text").children("p:eq(0)").find(".owner-nickname").html(),commentState=Number($(this).attr("commentTime"));if(commentState){var parentId=newsId.split(":")[0];newsId=newsId.split(":")[1]}else var parentId=newsId;layer.prompt({formType:2,title:"请填写回复"+ownerNickname+"的话"},function(value,index){layer.close(index);var commentHead=layui.data("lightly").userInfo.headImage,commentNickname=layui.data("lightly").userInfo.nickname,unixTime=Math.round((new Date).getTime()/1e3),submitComment=layer.open({type:3,shade:[.6,"#000000"]});$.ajax({type:"GET",url:"/plugin/LittleFunction/Change.php",data:"type=3&userId="+userId+"&newsId="+newsId+"&parentId="+parentId+"&content="+encodeURIComponent(value)+"&user="+user+"&unixTime="+unixTime+"&ownerNickname="+encodeURIComponent(ownerNickname),dataType:"json",success:function(res){var result=eval(res);if(1==Number(result.status)){var dom='<li class="layui-timeline-item" style="list-style:none;z-index:2;margin-top:32px;" userId="'+user+'" newsId="'+parentId+":"+result.data+'"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text"><p><a><img src="'+commentHead+'" class="layui-nav-img"><span class="owner-nickname">'+commentNickname+"</span>回复"+ownerNickname+"</a></p><p>"+value+'</p><div class="layui-col-md4 layui-col-lg4 layui-col-sm12 layui-col-xs12 layui-col-md-offset8 layui-col-lg-offset8" style="font-size:8px;">'+unix2common(unixTime)+'</div><div class="layui-col-md2 layui-col-lg2 layui-col-sm12 layui-col-xs12 layui-col-md-offset8 layui-col-lg-offset8 icon-box"><i class="layui-icon layui-icon-praise thumb-btn" title="赞" totState="0"></i><span>0</span><i class="layui-icon layui-icon-tread tread-btn" title="踩" totState="0"></i><span>0</span><i class="layui-icon layui-icon-dialogue dialogue-btn" title="评论"  commentTime="1"></i></div></div></li>';commentState?ownerDom.parent(".comment-box").append(dom):ownerDom.find(".comment-box").append(dom),clickThumbOrTread(),layer.close(submitComment),layer.msg("评论成功")}}})})})}var $=layui.$,layer=layui.layer,user=layui.data("lightly").user;null==user&&(layer.msg("未登陆"),$(function(){setTimeout(function(){$(location).attr("href","/login.html")},300)}));var layim=layui.layim,initLayim=!0,userStatus="",showInputState=!0,isPC=!0,ajaxIndex=0;if(newJoin=0,isPC)var allPageLoad=layer.open({type:3,shade:[1,"#ffffff"]});"none"==$(".device-type").css("display")&&(isPC=!1,$(".container-box").css("display","block"),$(".layer-footer").css("display","block")),$(".head-image").attr("src",layui.data("lightly").userInfo.headImage),$(".nickname").html(layui.data("lightly").userInfo.nickname),$("#exit").click(function(){layer.open({type:1,title:"提示",offset:"auto",content:'<div style="padding: 20px 100px;">期待与你下次相遇!</div>',btn:"退出账户",btnAlign:"c",shade:0,yes:function(){layer.closeAll(),layui.data("lightly",null),$(location).attr("href","/login.html")}})}),$.ajax({type:"GET",url:"/plugin/LittleFunction/Search.php",data:"type=11&user="+user,dataType:"json",success:function(res){var result=eval(res);1==Number(result.status)&&(1==Number(result.data)?$.ajax({type:"GET",url:"/plugin/LittleFunction/Search.php",data:"type=8",dataType:"json",success:function(res){function strongestDom(t,e,a){var i='<li class="layui-timeline-item"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text"><p><a><img src="'+t+'" class="layui-nav-img">'+e+"</a></p><p>"+a+"</p></div></li>";return i}var result=eval(res);if(1==Number(result.status)){var firstContent="总共获得若轻分"+result.data[0].todayScore+",荣登榜首,恭喜",secondContent="总共获得若轻分"+result.data[1].todayScore+",银牌王者,祝贺",thirdContent="总共获得若轻分"+result.data[2].todayScore+",铜色闪耀,共勉",dom=strongestDom(result.data[0].userHead,result.data[0].nickname,firstContent)+strongestDom(result.data[1].userHead,result.data[1].nickname,secondContent)+strongestDom(result.data[2].userHead,result.data[2].nickname,thirdContent);$(".today-strongest").append(dom),1==ajaxIndex?($(".layui-container").css("display","block"),$(".phone-nav").css("display","block"),layer.close(allPageLoad)):ajaxIndex++}}}):($(".lightly-strongest").css("display","none"),1==ajaxIndex?($(".layui-container").css("display","block"),$(".phone-nav").css("display","block"),layer.close(allPageLoad)):ajaxIndex++))}}),$.ajax({type:"GET",url:"/plugin/LittleFunction/Search.php",data:"type=7&user="+user,dataType:"json",success:function(res){var result=eval(res);if(1==Number(result.status)){if(!result.data.length){var dom='<li class="layui-timeline-item layui-col-md12 layui-col-lg12 layui-col-sm12 layui-col-xs12"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text">暂无消息!</div></li>';return $(".friend-news").append(dom),void(1==ajaxIndex?($(".layui-container").css("display","block"),layer.close(allPageLoad)):ajaxIndex++)}var dom="",userId=Number(user.split("_")[2]),comment=result.data[0].comment,commentDomArr=[],commentIndexArr=[],commentOwnerArr=[];if(1==Number(comment.status))for(var i=0;i<comment.data.length;i++){var totStr=comment.data[i].progress,thumbNum=0,treadNum=0;if(""==totStr)var thumbState='totState="0"',treadState='totState="0"';else{for(var totArr=totStr.split(","),idArr=[],totStateArr=[],j=0;j<totArr.length-1;j++){var temp=totArr[j].split(":");idArr.push(Number(temp[0]));var totNumber=Number(temp[1]);1==totNumber?++thumbNum:++treadNum,totStateArr.push(totNumber)}var idIndex=idArr.indexOf(Number(comment.data[i].userTable.split("_")[2]),0);if(-1==idIndex)var thumbState='totState="0"',treadState='totState="0"';else if(1==totStateArr[idIndex])var thumbState='style="color:#FF5722;" totState="1"',treadState='totState="1"';else var thumbState='totState="2"',treadState='style="color:#FF5722;" totState="2"'}commentOwnerArr[i]=comment.data[i].ownerTable,commentIndexArr[i]=Number(comment.data[i].parentId),commentDomArr[i]='<li class="layui-timeline-item" style="list-style:none;z-index:2;margin-top:32px;" userId="'+comment.data[i].userTable+'" newsId="'+comment.data[i].parentId+":"+comment.data[i].newsId+'"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text"><p><a><img src="'+comment.data[i].userHead+'" class="layui-nav-img"><span class="owner-nickname">'+comment.data[i].nickname+"</span>回复"+comment.data[i].preNickname+"</a></p><p>"+comment.data[i].content+'</p><div class="layui-col-md4 layui-col-lg4 layui-col-sm12 layui-col-xs12 layui-col-md-offset8 layui-col-lg-offset8" style="font-size:8px;">'+unix2common(comment.data[i].time)+'</div><div class="layui-col-md2 layui-col-lg2 layui-col-sm12 layui-col-xs12 layui-col-md-offset8 layui-col-lg-offset8 icon-box"><i class="layui-icon layui-icon-praise thumb-btn" title="赞" '+thumbState+"></i><span>"+thumbNum+'</span><i class="layui-icon layui-icon-tread tread-btn" title="踩" '+treadState+"></i><span>"+treadNum+'</span><i class="layui-icon layui-icon-dialogue dialogue-btn" title="评论"  commentTime="1"></i></div></div></li>'}for(var i=0;i<result.data.length;i++){var totStr=result.data[i].progress,thumbNum=0,treadNum=0;if(""==totStr)var thumbState='totState="0"',treadState='totState="0"';else{for(var totArr=totStr.split(","),idArr=[],totStateArr=[],j=0;j<totArr.length-1;j++){var temp=totArr[j].split(":");idArr.push(Number(temp[0]));var totNumber=Number(temp[1]);1==totNumber?++thumbNum:++treadNum,totStateArr.push(totNumber)}var idIndex=idArr.indexOf(userId,0);if(-1==idIndex)var thumbState='totState="0"',treadState='totState="0"';else if(1==totStateArr[idIndex])var thumbState='style="color:#FF5722;" totState="1"',treadState='totState="1"';else var thumbState='totState="2"',treadState='style="color:#FF5722;" totState="2"'}switch(dom+='<li class="layui-timeline-item layui-col-md12 layui-col-lg12 layui-col-sm12 layui-col-xs12 owner-li" userId="'+result.data[i].userTable+'" newsId="'+result.data[i].newsId+'"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text"><p><a><img src="'+result.data[i].userHead+'" class="layui-nav-img"><span class="owner-nickname">'+result.data[i].nickname+"</span></a></p>",Number(result.data[i].type)){case 1:dom+="<p>"+result.data[i].content+'<br>再接再厉,继续加油 <i class="layui-icon layui-icon-face-smile" style="color:#FF5722;"></i></p>';break;case 2:dom+="<p>"+result.data[i].content+"获得胜利<br>预祝接下来仍旧旗开得胜</p>";break;case 3:dom+="<p>"+result.data[i].content+"惜败<br>努力加油,下次一定仍是王者</p>";break;case 6:dom+='<p>购买了"'+result.data[i].content+'"卡包<br>又是一段学习的时光<i class="layui-icon layui-icon-release"></i></p>'}dom+='<div class="layui-col-md4 layui-col-lg4 layui-col-sm12 layui-col-xs12 layui-col-md-offset8 layui-col-lg-offset8" style="font-size:8px;">'+unix2common(result.data[i].time)+'</div><div class="layui-col-md2 layui-col-lg2 layui-col-sm12 layui-col-xs12 layui-col-md-offset8 layui-col-lg-offset8 icon-box"><i class="layui-icon layui-icon-praise thumb-btn" title="赞" '+thumbState+"></i><span>"+thumbNum+'</span><i class="layui-icon layui-icon-tread tread-btn" title="踩" '+treadState+"></i><span>"+treadNum+'</span><i class="layui-icon layui-icon-dialogue dialogue-btn" title="评论" commentTime="0"></i></div><div class="layui-col-md12 layui-col-lg12 layui-col-sm12 layui-col-xs12"><ul class="layui-timeline comment-box">';for(var j=0;j<commentIndexArr.length;j++)Number(result.data[i].newsId)==commentIndexArr[j]&&result.data[i].userTable==commentOwnerArr[j]&&(dom+=commentDomArr[j]);dom+="</ul></div></div></li>"}dom+='<li class="layui-timeline-item layui-col-md12 layui-col-lg12 layui-col-sm12 layui-col-xs12"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text">已经到底啦!</div></li>',$(".friend-news").append(dom),clickThumbOrTread(),1==ajaxIndex?($(".layui-container").css("display","block"),layer.close(allPageLoad)):ajaxIndex++}}}),isPC&&(initLayim=!1,ws=new WebSocket("ws://lightly.52ch.top:8686"),createLayim(ws,$,layim,layer,user,userStatus,showInputState)),$(window).resize(function(){isPC="none"!=$(".device-type").css("display"),isPC&&initLayim?(initLayim=!1,ws=new WebSocket("ws://lightly.52ch.top:8686"),createLayim(ws,$,layim,layer,user,userStatus,showInputState)):isPC||initLayim||(initLayim=!0,ws.close(),$(".layui-layer").remove())})});