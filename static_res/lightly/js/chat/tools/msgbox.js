layui.use(["layim","jquery","layer","util"],function(){var layim=layui.layim,layer=layui.layer,util=layui.util,$=layui.$,user=layui.data("lightly").user,newJoinNumber=parent.newJoin,ws=new WebSocket("ws://lightly.52ch.top:8686");if(newJoinNumber>0){var getNewJoin=layer.load(3);$.ajax({type:"GET",url:"/plugin/Chat/tools/NewFriendsInfo.php",data:"type=1&user="+user,dataType:"json",success:function(data){var result=eval(data),data=result.data,friendData="",groupData="";if(2==result.status){if(0==data.friend.status&&0==data.group.status&&0==data.refuse.status){var showInfo='<li class="layim-msgbox-system"><p><em>系统：</em><span>暂无申请</span></p></li>';$(".layim-msgbox").append(showInfo)}if(1==data.friend.status){for(var friendData=data.friend.data,showInfo="",i=0;i<friendData.length;i++){var time=Number(friendData[i].addTime),unixTimestamp=new Date(1e3*time),commonTime=unixTimestamp.toLocaleString();showInfo+='<li><a><img src="'+friendData[i].head+'"class="layui-circle layim-msgbox-avatar"></a><p class="layim-msgbox-user"><span>'+friendData[i].nickname+"</span><span>"+commonTime+'</span></p><p class="layim-msgbox-content">申请添加你为好友<span>附言: '+friendData[i].remark+'</span></p><p class="layim-msgbox-btn"><button class="layui-btn layui-btn-small" userId="'+i+'" lay-active="friendAgree">同意</button><button class="layui-btn layui-btn-small layui-btn-primary" userId="'+i+'"  lay-active="friendRefuse">拒绝</button></p></li>'}$(".layim-msgbox").append(showInfo)}if(1==data.group.status){for(var groupData=data.group.data,showInfo="",i=0;i<groupData.length;i++){var time=Number(groupData[i].addTime),unixTimestamp=new Date(1e3*time),commonTime=unixTimestamp.toLocaleString();showInfo+='<li><a><img src="'+groupData[i].head+'"class="layui-circle layim-msgbox-avatar"></a><p class="layim-msgbox-user"><span>'+groupData[i].nickname+"</span><span>"+commonTime+'</span></p><p class="layim-msgbox-content">申请添加到群:<span>'+groupData[i].groupName+"</span> 附言: <span>"+groupData[i].remark+'</span></p><p class="layim-msgbox-btn"><button class="layui-btn layui-btn-small" userId="'+i+'" lay-active="groupAgree">同意</button><button class="layui-btn layui-btn-small layui-btn-primary" userId="'+i+'" lay-active="groupRefuse">拒绝</button></p></li>'}$(".layim-msgbox").append(showInfo)}if(1==data.refuse.status){for(var showInfo="",i=0;i<data.refuse.data.length;i++)showInfo='<li class="layim-msgbox-system"><p><em>系统：</em><span>'+data.refuse.data[i]+"拒绝了你的申请</span></p></li>";$(".layim-msgbox").append(showInfo)}layer.close(getNewJoin)}util.event("lay-active",{friendAgree:function(){var a=$(this).parent().parent();a.addClass("layui-anim layui-anim-fadeout"),setTimeout(function(){a.css("display","none")},600);var e=Number($(this).attr("userId")),i=friendData[e];layim.setFriendGroup({type:"friend",username:i.nickname,avatar:i.head,group:layim.cache().friend,submit:function(a,e){var n={infoType:6,joinType:0,comfirmType:0,mineTable:user,friendTable:i.friendTable};ws.send(JSON.stringify(n));var s={type:"friend",avatar:i.head,username:i.nickname,groupid:1,id:i.friendTable,sign:i.sign};parent.layui.layim.addList(s),layer.close(e)}})},friendRefuse:function(){var a=$(this).parent().parent();a.addClass("layui-anim layui-anim-fadeout"),setTimeout(function(){a.css("display","none")},600);var e=Number($(this).attr("userId")),i=friendData[e],n={infoType:6,joinType:0,comfirmType:1,mineTable:user,friendTable:i.friendTable};ws.send(JSON.stringify(n)),layer.msg("处理成功")},groupAgree:function(){var a=$(this).parent().parent();a.addClass("layui-anim layui-anim-fadeout"),setTimeout(function(){a.css("display","none")},600);var e=Number($(this).attr("userId")),i=groupData[e],n={infoType:6,joinType:1,comfirmType:0,friendTable:i.friendTable,groupTable:i.groupTable,avatar:i.groupHead,groupname:i.groupName};ws.send(JSON.stringify(n)),layer.msg("处理成功")},groupRefuse:function(){var a=$(this).parent().parent();a.addClass("layui-anim layui-anim-fadeout"),setTimeout(function(){a.css("display","none")},600);var e=Number($(this).attr("userId")),i=groupData[e],n={infoType:6,joinType:1,comfirmType:1,friendTable:i.friendTable,groupTable:i.groupTable};ws.send(JSON.stringify(n)),layer.msg("处理成功")}})}})}});